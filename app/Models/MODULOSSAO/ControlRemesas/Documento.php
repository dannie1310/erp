<?php
/**
 * Created by PhpStorm.
 * User: DBenitezc
 * Date: 23/05/2019
 * Time: 06:32 PM
 */

namespace App\Models\MODULOSSAO\ControlRemesas;


use App\Models\CADECO\Empresa;
use App\Models\CADECO\Finanzas\DistribucionRecursoRemesa;
use App\Models\CADECO\Finanzas\DistribucionRecursoRemesaPartida;
use App\Models\CADECO\Fondo;
use App\Models\CADECO\Moneda;
use App\Models\CADECO\Obra;
use App\Models\CADECO\Transaccion;
use App\Models\SEGURIDAD_ERP\Fiscal\CtgNoLocalizado;
use Illuminate\Database\Eloquent\Model;
use App\Facades\Context;
use Exception;
use Illuminate\Support\Facades\Config;
use Illuminate\Support\Facades\DB;

class Documento extends Model
{
    protected $connection = 'modulosao';
    protected $table = 'ModulosSAO.ControlRemesas.Documentos';
    protected $primaryKey = 'IDDocumento';
    public $timestamps = false;

    protected $dates =["Fecha"];
    /*protected $dateFormat = 'M d Y h:i:s A';*/

    protected $hidden = ['disponible'];

    protected static function boot()
    {
        parent::boot(); // TODO: Change the autogenerated stub

        self::addGlobalScope(function ($query){
            return $query->has('documentoLiberado')->whereHas('documentoProcesado', function ($query){
                return $query->where('IDProceso', '=', 4)->where('MontoAutorizadoPrimerEnvio', '>', 0)->orWhere('MontoAutorizadoSegundoEnvio', '>', 0);
            });
        });
    }

    /**
     * Relaciones
     */
    public function moneda(){
        return $this->belongsTo(Moneda::class, 'IDMoneda', 'id_moneda');
    }

    public function remesa(){
        return $this->belongsTo(Remesa::class, 'IDRemesa', 'IDRemesa');
    }

    public function remesaSinScopeGlobal()
    {
        return $this->hasOne(Remesa::class, 'IDRemesa', 'IDRemesa')->withoutGlobalScopes();
    }

    public function documentoLiberado()
    {
        return $this->belongsTo(DocumentoLiberado::class, 'IDDocumento', 'IDDocumento');
    }

    public function documentoProcesado(){
        return $this->hasMany(DocumentoProcesado::class, 'IDDocumento');
    }

    public function partidas(){
        return $this->belongsTo(DistribucionRecursoRemesaPartida::class, 'IDDocumento', 'id_documento');
    }

    public function destinatario()
    {
        return $this->belongsTo(DocumentoDestinatario::class, 'IDDestinatario', 'IDDestinatario');
    }

    public function empresaDocumentoManual()
    {
        return $this->belongsTo(Empresa::class, 'IDDestinatario', 'id_empresa');
    }

    public function fondo()
    {
        return $this->belongsTo(Fondo::class, 'IDDestinatario', 'id_fondo');
    }

    public function tipoDocumento(){
        return $this->belongsTo(TipoDocumento::class, 'IDTipoDocumento', 'IDTipoDocumento');
    }

    public function origenDocumento(){
        return $this->belongsTo(OrigenDocumento::class, 'IDOrigenDocumento', 'IDOrigenDocumento');
    }

    public function transaccion(){
        DB::purge('cadeco');
        Config::set('database.connections.cadeco.database',  $this->remesaSinScopeGlobal->proyecto->unificacionProyectoObra->baseDatosObraSinScopeGlobal->BaseDatos);
        return $this->belongsTo(Transaccion::class, 'IDTransaccionCDC', 'id_transaccion')->withoutGlobalScopes();
    }

    public function partidasDispersion(){
        return $this->hasMany(DistribucionRecursoRemesaPartida::class, 'id_documento', 'IDDocumento');
    }

    /**
     * Scope
     */
    public function  scopeDisponiblesParaDistribuir($query, $id_remesa){

        $existentes = DistribucionRecursoRemesa::select('id')->where('id_remesa', '=', $id_remesa)->where('estado','>=', 0)->get()->toArray();
        $documentos = DistribucionRecursoRemesaPartida::select('id_documento')->whereIn('id_distribucion_recurso', $existentes)->where('estado','>=', 0)->get()->toArray();

        return $query->whereNotIn('IDDocumento', $documentos);
    }

    public function scopeMontoDocumentoProcesado($query){
        $query->has('documentoProcesado', function ($q) {
            return $q->where('IDProceso', '=', 4);
        });
    }

    public function scopeSeleccionado($query)
    {
        return $query->where('Seleccionado', 1);
    }

    /**
     * Atributos
     */

    public function getFechaFormatAttribute()
    {
        $date = date_create($this->Fecha);
        return date_format($date,"d/m/Y");
    }

    public function getPartidaVigenteAttribute(){
        foreach ($this->partidasDispersion as $partida){
            if($partida->estado >= 0){
                return $partida;
            }
        }
    }

    public function getImporteTotalAttribute(){
        if($this->IDMoneda != 1) {
            $moneda = Moneda::with('cambio')->where('id_moneda', '=', $this->IDMoneda)->get()->toArray();
            return $this->MontoTotal * $moneda[0]['cambio']['cambio'];
        }else {
            return $this->MontoTotal;
        }
    }

    public function getImporteTotalProcesadoAttribute(){
        foreach ($this->documentoProcesado as $item){
            if($item->IDProceso == 4){
                $monto = $item->MontoAutorizadoPrimerEnvio + $item->MontoAutorizadoSegundoEnvio;
                return $monto;
            }
        }
    }

    public function getBeneficiarioAttribute()
    {
        if($this->IDTipoDocumento == 12){
             $fondo = Fondo::select('nombre')->where('id_fondo','=', $this->IDDestinatario)->first();
             if($fondo){
                 return $fondo->nombre;
             }
        }else{
            $empresa = Empresa::select('razon_social')->where('id_empresa','=', $this->IDDestinatario)->first();
            if($empresa){
                return $empresa->razon_social;
            }
        }
        return null;
    }
    /*
     * Este método se crea para devolver el id de cuenta del proveedor en caso de tener una sola cuenta activa
     * de modo que en el formulario de dispersión quede preseleccionado
     * */
    public function getCuentaAbonoAttribute(){
        if($this->empresa){
            $cuentas = $this->empresa->cuentasBancarias;
            if(sizeof($cuentas) === 1){
                return $cuentas[0]->id;
            }else{
                return null;
            }
        }
        else {
            return null;
        }
    }

    /*
     * Este método se crea para devolver el id de cuenta corriente pagadora en caso de que el proyecto tenga una sola cuenta
     * activa de modo que en el formulario de dispersión quede preseleccionada
     * */
    public function getCuentaCargoAttribute(){
        $obra = Obra::find(Context::getIdObra());
        if($obra) {
            $cuentas = $obra->cuentasPagadorasObra;
            if (sizeof($cuentas) === 1) {
                return $cuentas[0]->id_cuenta;
            } else {
                return null;
            }
        }
        return null;
    }

    public function getProveedorAttribute()
    {
        if($this->IDTransaccionCDC == null && $this->IDOrigenDocumento == 2){
            return $this->empresaDocumentoManual->razon_social;
        }
        if($this->transaccion == null){
            $pre = '"';
            if(in_array('IDTipoDocumento', [12,13,14,15])){
                $pre = 'solicitud de "';
            }
            abort(403, 'La dispersión no puede descargarse porque la '.$pre.$this->tipoDocumento->TipoDocumento.'" con número de folio "'.$this->NumeroFolio.'" y de concepto"'.$this->Observaciones.'" fue eliminado de SAO');
        }else if($this->transaccion->id_referente != null){
            if($this->transaccion->fondoFijo->empresa){
                return $this->transaccion->fondoFijo->empresa->razon_social;
            }
            return null;
        }
        return $this->transaccion->empresa->razon_social;
    }

    public function getRFCAttribute()
    {
        if($this->IDTransaccionCDC == null && $this->IDOrigenDocumento == 2){
            return $this->empresaDocumentoManual->rfc;
        }
        if($this->transaccion->id_referente != null){
            if($this->transaccion->fondoFijo->empresa){
                return $this->transaccion->fondoFijo->empresa->rfc;
            }
            return null;
        }
        return $this->transaccion->empresa->rfc;
    }

    public function getEmpresaCadecoAttribute(){
        if($this->IDTransaccionCDC == null && $this->IDOrigenDocumento == 2){
            return $this->empresaDocumentoManual;
        }
        return $this->transaccion->empresa;  
    }

    /**
     * Métodos
     */
}
